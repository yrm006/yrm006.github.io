<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>SARSnCov2</title>
  
  <script>
  const X0=128, Y0=X0, R=X0, FPS=30, GPS=2;
  const Ru=2, Tk=10*FPS, Ph=0.20, Pa=0.14;
  const S_KENKO=0, S_KEIDO=1, S_JUUDO=2, S_KOTAI=3;
  const S_COLORS = ["#2222dd", "#dd66ff", "#ff2222", "#22ff22"];
  let ctx, grh;
  let people;
  let gx;
  let Sp;

  function Person(){
    this.x = 0;
    this.y = 0;
    this.vx = (Math.random()-0.5)*2.0*Sp;
    this.vy = (Math.random()-0.5)*2.0*Sp;
    this.vx_back = this.vx;
    this.vy_back = this.vy;
    this.s = S_KENKO;
    this.t = 0;

    while(R*R <= (this.x-X0)*(this.x-X0)+(this.y-Y0)*(this.y-Y0)){
      this.x = Math.random()*(R*2);
      this.y = Math.random()*(R*2);
    }

    this.setStatus = function(s){
        if(s == S_KEIDO){
            this.t = Tk * Math.random();
        }

        if(s == S_JUUDO){
            this.vx = 0;
            this.vy = 0;
            this.t = Tk;
        }
        if(this.s == S_JUUDO && s != S_JUUDO){
            this.vx = this.vx_back;
            this.vy = this.vy_back;
        }

        this.s = s;
    };

    this.tick = function(){
      this.x += this.vx;
      this.y += this.vy;
      if(R*R <= (this.x-X0)*(this.x-X0)+(this.y-Y0)*(this.y-Y0)){
        let s0 = Math.atan2(this.y-Y0, this.x-X0);
        let s = Math.atan2(this.vy, this.vx);
        let sn = s0 + Math.PI + (s0 - s);
        let v = Math.sqrt(this.vx*this.vx + this.vy*this.vy);
        this.vx = Math.cos(sn) * v;
        this.vy = Math.sin(sn) * v;
        this.x += this.vx;
        this.y += this.vy;
      }

      if(this.s == S_KEIDO){
        if(--this.t < 0){
            this.setStatus( (Math.random()<Ph) ? S_JUUDO : (Math.random()<Pa) ? S_KENKO : S_KOTAI );
        }
      }else
      if(this.s == S_JUUDO){
        if(--this.t < 0){
            this.setStatus( (Math.random()<Pa) ? S_KENKO : S_KOTAI );
        }
      }
    };
  }

  function draw(){
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

    ctx.beginPath();
    ctx.arc(X0, Y0, R, 0, 2*Math.PI);
    ctx.fillStyle = "#dddddd";
    ctx.fill();

    let n = people.length;
    while(n--){
      let o = people[n];
      ctx.beginPath();
      ctx.arc(o.x, o.y, 2, 0, 2*Math.PI);
      ctx.fillStyle = S_COLORS[o.s];
      ctx.fill();
    }
  }

  function tick(){
    let n = people.length;
    while(n--){
        people[n].tick();
    }

    n = people.length;
    while(n--){
      let m = n;
      while(m--){
        let dx = people[n].x - people[m].x;
        let dy = people[n].y - people[m].y;
        if(dx*dx+dy*dy < Ru*Ru){
            if(people[n].s==S_KEIDO && people[m].s==S_KENKO) people[m].setStatus( S_KEIDO );
            if(people[m].s==S_KEIDO && people[n].s==S_KENKO) people[n].setStatus( S_KEIDO );
        }
      }
    }

    draw();

    setTimeout(tick, 1000/FPS);
  }

  function drawg(c){
    let y = grh.canvas.height;
    let p = y / people.length;

    grh.beginPath();
    grh.moveTo(gx,y);
    grh.lineTo(gx,y-=c[2]*p);
    grh.strokeStyle = S_COLORS[2];
    grh.stroke();
    grh.beginPath();
    grh.moveTo(gx,y);
    grh.lineTo(gx,y-=c[1]*p);
    grh.strokeStyle = S_COLORS[1];
    grh.stroke();
    grh.beginPath();
    grh.moveTo(gx,y);
    grh.lineTo(gx,y-=c[3]*p);
    grh.strokeStyle = S_COLORS[3];
    grh.stroke();
    grh.beginPath();
    grh.moveTo(gx,y);
    grh.lineTo(gx,y-=c[0]*p);
    grh.strokeStyle = S_COLORS[0];
    grh.stroke();

    ++gx;
  }

  function check(){
    let c = [0,0,0,0];

    let n = people.length;
    while(n--){
        ++c[people[n].s];
    }

    drawg(c);

    setTimeout(check, 1000/GPS);
  }

  function init(c, g, sp, n){
    let first = (people === undefined);

    Sp = sp;

    ctx = c;
    grh = g;

    people = new Array(n);
    while(n--){
        people[n] = new Person();
    }

    people[0].setStatus( S_KEIDO );

    gx = 0;
    grh.clearRect(0, 0, grh.canvas.width, grh.canvas.height);

    if(first){
        tick();
        check();
    }
  }
  </script>
</head>

<body onload="">
    <p>
        People Moving: 
        <input id="Sp" type="text" value="1.0" style="width:5em;">
        <input type="button" value="Simulate" onclick="init(document.getElementById('cvs').getContext('2d'), 
                                                        document.getElementById('grh').getContext('2d'), 
                                                        Number(document.getElementById('Sp').value), 
                                                        512);">
    </p>
    <canvas id="cvs" width="256" height="256"></canvas><br>
    <canvas id="grh" width="256" height="128"></canvas><br>
</body>

</html>